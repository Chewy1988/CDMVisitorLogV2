<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>iPad Visitor Log</title>

<meta name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#34c759">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="logo.png">

<style>
/* ------------------ Base ------------------ */
body {
  margin: 0;
  padding: 10px;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f2f2f7;
  height: 100vh;
  overflow: hidden;
}
body.input-focused { overflow: hidden; }

/* ------------------ Layout ------------------ */
.container {
  max-width: 1000px;
  height: 90vh;
  margin: auto;
  display: flex;
  gap: 15px;
}

.left-column, .right-column {
  background: white;
  border-radius: 20px;
  padding: 15px;
  box-shadow: 0 10px 25px rgba(0,0,0,.1);
}

.left-column {
  flex: 2;
  display: flex;
  flex-direction: column;
  position: relative;
}

.right-column {
  flex: 1;
  overflow-y: auto;
}

/* ------------------ Typography ------------------ */
h1 { text-align: center; font-size: 26px; margin: 10px 0; }
h2 { font-size: 20px; margin: 12px 0; }

input {
  width: 100%;
  padding: 14px;
  font-size: 22px;
  border-radius: 12px;
  border: 1px solid #ccc;
  margin-bottom: 12px;
}
#companyInput { font-size: 18px; }

.buttons {
  display: flex;
  gap: 8px;
}

button {
  padding: 14px;
  font-size: 20px;
  border-radius: 14px;
  border: none;
  cursor: pointer;
}

.sign-in { background: #34c759; color: white; }
.sign-out { background: #ff3b30; color: white; }

/* ------------------ Lists ------------------ */
ul { list-style: none; padding: 0; margin: 0; }
li {
  background: #f2f2f7;
  margin: 6px 0;
  padding: 10px 14px;
  border-radius: 10px;
  font-size: 18px;
  cursor: pointer;
}

/* Previous visitor row */
.prev-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.prev-item span { flex: 1; }
.prev-item button {
  background: transparent;
  border: none;
  color: #ff3b30;
  font-size: 20px;
  cursor: pointer;
}

/* ------------------ Fixed Export Button ------------------ */
.export {
  position: absolute;
  bottom: 16px;
  right: 16px;
  width: 110px;
  height: 44px;
  font-size: 14px;
  border-radius: 10px;
  background: #8e8e93;
  color: white;
}
.export:active { transform: scale(.97); }

/* ------------------ Modals ------------------ */
.modal-wrap { display:none; }
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.4);
}
.modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%,-50%);
  background: white;
  padding: 25px;
  border-radius: 16px;
  width: 90%;
  max-width: 400px;
  text-align: center;
}
.modal button {
  width: 100%;
  margin-top: 10px;
}

/* ------------------ Mobile ------------------ */
@media(max-width:900px){
  .container { flex-direction: column; height: auto; }
}
</style>
</head>

<body>

<!-- ------------------ Modals ------------------ -->
<div id="confirmModal" class="modal-wrap">
  <div class="modal-backdrop"></div>
  <div class="modal">
    <h3>Have you been inducted?</h3>
    <button class="sign-in" onclick="confirmInduction(true)">Yes</button>
    <button class="sign-out" onclick="confirmInduction(false)">No</button>
  </div>
</div>

<div id="passcodeModal" class="modal-wrap">
  <div class="modal-backdrop"></div>
  <div class="modal">
    <h3>Enter Passcode</h3>
    <input id="passcodeInput" type="password">
    <button class="sign-in" onclick="checkPasscode()">Submit</button>
    <button class="sign-out" onclick="closeModal('passcodeModal')">Cancel</button>
  </div>
</div>

<!-- ------------------ App ------------------ -->
<div class="container">

  <div class="left-column">
    <img src="logo.png" style="max-width:180px;margin:auto;">
    <h1>Project Argo CDM</h1>

    <input id="nameInput" placeholder="Name">
    <input id="companyInput" placeholder="Company">

    <div class="buttons">
      <button class="sign-in" onclick="signIn()">Sign In</button>
      <button class="sign-out" onclick="signOut()">Sign Out</button>
    </div>

    <h2>Currently Signed In</h2>
    <ul id="activeList"></ul>

    <button class="export" onclick="requestExport()">Report</button>
  </div>

  <div class="right-column">
    <h2>Previous Visitors</h2>
    <ul id="previousList"></ul>
  </div>

</div>

<script>
/* ------------------ Storage ------------------ */
let visits = JSON.parse(localStorage.getItem("visits") || "[]");
let previous = JSON.parse(localStorage.getItem("previousVisitors") || "[]");
let deleted = JSON.parse(localStorage.getItem("deletedVisitors") || "[]");

const nameInput = document.getElementById("nameInput");
const companyInput = document.getElementById("companyInput");

/* Prevent scroll on keyboard */
[nameInput, companyInput].forEach(i=>{
  i.onfocus=()=>document.body.classList.add("input-focused");
  i.onblur=()=>document.body.classList.remove("input-focused");
});

/* ------------------ Helpers ------------------ */
function save(){
  localStorage.setItem("visits",JSON.stringify(visits));
  localStorage.setItem("previousVisitors",JSON.stringify(previous));
  localStorage.setItem("deletedVisitors",JSON.stringify(deleted));
  render();
}

function openModal(id){ document.getElementById(id).style.display="block"; }
function closeModal(id){ document.getElementById(id).style.display="none"; }

/* ------------------ Render ------------------ */
function render(){
  activeList.innerHTML="";
  previousList.innerHTML="";

  const signedIn = visits.filter(v=>!v.out);

  signedIn.forEach(v=>{
    const li=document.createElement("li");
    li.textContent=`${v.name} (${v.company})`;
    li.onclick=()=>{ nameInput.value=v.name; companyInput.value=v.company; };
    activeList.appendChild(li);
  });

  previous
    .filter(n=>!signedIn.some(v=>v.name===n))
    .filter(n=>!deleted.includes(n))
    .forEach(name=>{
      const v=[...visits].reverse().find(x=>x.name===name);
      const li=document.createElement("li");
      li.className="prev-item";

      const span=document.createElement("span");
      span.textContent=`${name} (${v?.company||""})`;

      const del=document.createElement("button");
      del.textContent="Ã—";
      del.onclick=e=>{
        e.stopPropagation();
        deleted.push(name);
        save();
      };

      li.append(span,del);
      previousList.appendChild(li);
    });
}

/* ------------------ Actions ------------------ */
function signIn(){
  const n=nameInput.value.trim();
  const c=companyInput.value.trim();
  if(!n||!c) return alert("Enter name and company");
  openModal("confirmModal");
  window._pending={n,c};
}

function confirmInduction(ok){
  closeModal("confirmModal");
  if(!ok) return;
  visits.push({name:_pending.n,company:_pending.c,in:new Date(),out:null});
  if(!previous.includes(_pending.n)) previous.push(_pending.n);
  nameInput.value=""; companyInput.value="";
  save();
}

function signOut(){
  const v=visits.find(x=>x.name===nameInput.value && !x.out);
  if(!v) return alert("Not signed in");
  v.out=new Date();
  save();
}

/* ------------------ Export ------------------ */
function requestExport(){
  openModal("passcodeModal");
}
function checkPasscode(){
  if(passcodeInput.value!=="8877") return alert("Wrong passcode");
  closeModal("passcodeModal");
  let csv="Name,Company,In,Out\n";
  visits.forEach(v=>{
    csv+=`${v.name},${v.company},${v.in},${v.out||""}\n`;
  });
  const b=new Blob([csv]);
  const a=document.createElement("a");
  a.href=URL.createObjectURL(b);
  a.download="visitors.csv";
  a.click();
}

render();
</script>

</body>
</html>
